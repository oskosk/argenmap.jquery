(function(c){function l(a,d){var b=1,e,c;c=a.length;e=0;for(c;e<c;e++)b*=a.charCodeAt(e)*n,b-=Math.floor(b);return d[Math.floor(b*d.length)]}function p(a,d){var b=null;this.element=a;this.$el=c(a);this.opts=c.extend({},q,d);this.gmap=null;this._marcadores={};this.init=function(){this.opts.center=new google.maps.LatLng(this.opts.center.lat,this.opts.center.lng);this.opts.streetViewControl=!1;this.opts.scaleControl=!0;this.opts.mapTypeControlOptions={style:google.maps.MapTypeControlStyle.DROPDOWN_MENU};
var a=f._prepararContenedor(this.$el);this.gmap=b=new google.maps.Map(a,this.opts);this.$el.data("gmap",b);google.maps.event.addListener(b,"maptypeid_changed",function(){b.setZoom(b.getZoom()+1);b.setZoom(b.getZoom()-1)});f.GmapAgregarCapaBase(b,new f.CapaBaseArgenmap);f.GmapAgregarCapa(b,new f.CapaTMSArgenmap);this.gmap.setMapTypeId("Mapa IGN");return!0};this.agregarCapaKML=function(a){var b={preserveViewport:!0,map:this.$el.data("gmap")};a=c.extend(b,a);new google.maps.KmlLayer(a)};this.infoWindow=
function(){void 0===this._infoWindow&&(this._infoWindow=new google.maps.InfoWindow);return this._infoWindow};this.agregarMarcador=function(a){var b=this,d={icon:f.BASEURL+"img/marcadores/punto.png",title:"Marcador",nombre:"Marcador_"+Math.floor(10100*Math.random())};a.icon=a.icono||void 0;a.data=a.contenido;a.position=new google.maps.LatLng(a.lat,a.lng);a.title=a.nombre;a=c.extend(d,a);a.map=b.$el.data("gmap");var k=new google.maps.Marker(a);this._marcadores[a.nombre]=k;google.maps.event.addListener(k,
"click",function(){a.contenido&&(b.infoWindow().open(b.$el.data("gmap"),k),b.infoWindow().setContent(a.contenido))})};this.quitarMarcador=function(a){void 0!==this._marcadores[a]&&(this._marcadores[a].setMap(null),delete this._marcadores[a])};this.modificarMarcador=function(a,b){if(void 0!==this._marcadores[a]){var d=this._marcadores[a];this.quitarMarcador(a);b=c.extend(d,b);b.nombre=a;this.agregarMarcador(b)}};this.geocodificar=function(a,b){c.getJSON("http://nominatim.openstreetmap.org/search?format=json&limit=5&q="+
a,function(a){a.length&&b(a);console.log(a)},this)};this.encuadrarResultadoDeGeocodificacion=function(a){var b=a.boundingbox[2],d=a.boundingbox[1];a=new L.LatLng(a.boundingbox[0],b);b=new L.LatLng(d,b);b=new L.LatLngBounds(a,b);this.Lmap.fitBounds(b)}}var m=["http://cg.aws.af.cm/tms","http://robomap-cgastrell.rhcloud.com/tms","http://sig.ign.gob.ar/tms","http://190.220.8.216/tms","http://mapaabierto.aws.af.cm/tms"],f={BASEURL:"http://www.ign.gob.ar/argenmap/argenmap.jquery/"},n=(Math.sqrt(5)-1)/2,
q={unit:"km",zoom:5,mapTypeControl:!0,center:{lat:-34,lng:-59}};Array.prototype.indexOf||(Array.prototype.indexOf=function(a,d){var b=this.length>>>0,e=Number(d)||0,e=0>e?Math.ceil(e):Math.floor(e);for(0>e&&(e+=b);e<b;e++)if(e in this&&this[e]===a)return e;return-1});f.cacheDeCliente=function(){this.MAX_TILES=150;this.cache=[];this.cacheRef={}};f.cacheDeCliente.prototype={recuperar:function(a,d,b){a=a+"-"+d+"-"+b;return-1!==this.cache.indexOf(a)?this.cacheRef[a]:!1},guardar:function(a,d,b,e){"string"!==
typeof this.baseURL&&(a=a+"-"+d+"-"+b,this.cache.push(a),this.cacheRef[a]=e,this.cache.length>this.MAX_TILES&&(e=this.cache.shift(),delete this.cacheRef[e]))}};f.CapaBaseWMS=function(a){this.gmap=this.imageMapType=null;this.name="Capa base WMS";this.tipo="wms-1.1.1";jQuery.extend(this,a);a={alt:this.name,getTileUrl:jQuery.proxy(this.getTileUrl,this),isPng:!0,maxZoom:17,minZoom:3,name:this.name,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(a)};f.CapaBaseWMS.prototype.getTileUrl=
function(a,d){var b=this.gmap.getProjection(),e=Math.pow(2,d),c=new google.maps.Point(256*a.x/e,256*(a.y+1)/e),e=new google.maps.Point(256*(a.x+1)/e,256*a.y/e),c=b.fromPointToLatLng(c),b=b.fromPointToLatLng(e),e=this.baseURL,h=this.layers,c=f.latLngAMercator(c.lat(),c.lng()),b=f.latLngAMercator(b.lat(),b.lng());return e+"LAYERS="+h+"&TRANSPARENT=FALSE&VERSION=1.1.1&SERVICE=WMS&REQUEST=GetMap&STYLES=&FORMAT=image%2Fpng&SRS=EPSG:3857&BBOX="+(c.lng+","+c.lat+","+b.lng+","+b.lat)+"&WIDTH=256&HEIGHT=256"};
f.CapaBaseTMS=function(a){this.cache=new f.cacheDeCliente;this.gmap=this.imageMapType=null;this.name="Capa base TMS";this.tipo="tms-1.0.0";jQuery.extend(this,a);a={alt:this.name,getTileUrl:jQuery.proxy(this.getTileUrl,this),isPng:!0,maxZoom:17,minZoom:3,name:this.name,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(a)};f.CapaBaseTMS.prototype.getTileUrl=function(a,d){var b=this.baseURL;if("string"!==typeof b){var b=l(a.x+""+a.y,b),c=this.cache.recuperar(a.x,
a.y,d);if(c)return c}b=b+"/"+this.layers+"/"+d+"/"+a.x+"/"+((1<<d)-a.y-1)+".png";this.cache.guardar(a.x,a.y,d,b);return b};f.CapaWMS=function(a){this.gmap=this.imageMapType=null;this.tipo="wms-1.1.1";this.alt=this.name="CAPA WMS";jQuery.extend(this,a);a={alt:this.alt,getTileUrl:jQuery.proxy(this.getTileUrl,this),isPng:!1,maxZoom:17,minZoom:6,name:this.name,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(a)};f.CapaWMS.prototype.getTileUrl=function(a,d){var b=
this.gmap.getProjection(),c=Math.pow(2,d),g=new google.maps.Point(256*a.x/c,256*(a.y+1)/c),c=new google.maps.Point(256*(a.x+1)/c,256*a.y/c),g=b.fromPointToLatLng(g),b=b.fromPointToLatLng(c),c=this.baseURL,h=this.layers,g=f.latLngAMercator(g.lat(),g.lng()),b=f.latLngAMercator(b.lat(),b.lng());return c+"VERSION=1.1.1&REQUEST=GetMap&LAYERS="+h+"&STYLES=&SRS=EPSG:3857&BBOX="+(g.lng+","+g.lat+","+b.lng+","+b.lat)+"&WIDTH=256&HEIGHT=256&FORMAT=image/png&TRANSPARENT=TRUE"};f.CapaTMS=function(a){this.cache=
new f.cacheDeCliente;this.gmap=this.imageMapType=null;this.tipo="tms-1.0.0";this.alt=this.name="CAPA TMS";jQuery.extend(this,a);a={alt:this.alt,getTileUrl:jQuery.proxy(this.getTileUrl,this),isPng:!1,maxZoom:17,minZoom:6,name:this.name,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(a)};f.CapaTMS.prototype.getTileUrl=function(a,d){var b=this.baseURL;if("string"!==typeof b){var b=l(a.x+""+a.y,b),c=this.cache.recuperar(a.x,a.y,d);if(c)return c}b=b+"/"+this.layers+
"/"+d+"/"+a.x+"/"+((1<<d)-a.y-1)+".png";this.cache.guardar(a.x,a.y,d,b);return b};f.CapaBaseArgenmap=function(){f.CapaBaseTMS.apply(this,[{name:"Mapa IGN",baseURL:m,layers:"capabaseargenmap"}])};f.CapaBaseArgenmap.prototype.getTileUrl=function(){return f.CapaBaseTMS.prototype.getTileUrl.apply(this,arguments)};f.CapaTMSArgenmap=function(){f.CapaTMS.apply(this,[{name:"IGN",baseURL:m,layers:"capabasesigign"}])};f.CapaTMSArgenmap.prototype.getTileUrl=function(a,d){return"satellite"!==this.gmap.getMapTypeId()?
!1:f.CapaTMS.prototype.getTileUrl.apply(this,arguments)};f.GmapAgregarCapaBase=function(a,d){var b;d.gmap=a;a.mapTypes.set(d.imageMapType.name,d.imageMapType);a.mapTypeControlOptions?(b=a.mapTypeControlOptions.mapTypeIds)?b.splice(0,0,d.imageMapType.name):b=[d.imageMapType.name,"satellite"]:b=[d.imageMapType.name,"satellite"];a.setOptions({mapTypeControlOptions:{mapTypeIds:b,style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}})};f.GmapAgregarCapa=function(a,d){d.gmap=a;a.overlayMapTypes.push(d.imageMapType)};
f._prepararContenedor=function(a){var d=f.BASEURL+"img/logoignsintexto-25px.png",b=c('<div class="argenmapMapCanvas" />').css({width:"100%","min-height":"200px"}),e=c('<div class="argenmapMapFooter" />').css({"font-family":"Arial","background-color":"#1C74A5","box-shadow":"0 0 11px rgb(5, 66, 100) inset","font-size":"10px","text-align":"right",height:"30px","vertical-align":"middle",color:"white","min-height":"25px","line-height":"13px",padding:"5px",margin:0,border:0}),g=c("<img />"),h=c('<a style="float:left" target="_blank" href="http://www.ign.gob.ar/argenmap/argenmap.jquery/docs"></a>').append(g);
g.attr("src",d).css({border:"0"});a.append(b);a.append(e);e.append(h);e.append('<a style="color:white;text-decoration:underline;font-weight:normal" target="_blank" href="http://www.ign.gob.ar/argenmap/argenmap.jquery/docs/#datosvectoriales">Top&oacute;nimos, datos topogr&aacute;ficos - 2013 IGN Argentina // Calles - OpenStreetMap</a>');f._maximizarCanvas(a,e,b);return b.get(0)};f._maximizarCanvas=function(a,d,b){var c=a.innerHeight()-d.outerHeight();b.height(c);a.bind("resized",function(c){c=a.innerHeight()-
d.outerHeight();b.height(c);google.maps.event.trigger(a.data().gmap,"resize")})};f.latLngAMercator=function(a,c){var b=2.003750834E7*c/180,e=Math.log(Math.tan((90+a)*Math.PI/360))/(Math.PI/180);return{lat:2.003750834E7*e/180,lng:b}};c.event.special.resized={interval:0,setup:function(){var a=this,d=c(this),b=d.width(),e=d.height();c.event.special.resized.interval=setInterval(function(){if(b!==d.width()||e!==d.height())b=d.width(),e=d.height(),jQuery.event.handle.call(a,{type:"resized"})},100)},teardown:function(){clearInterval(c.event.special.resized.interval)}};
c.fn.argenmap=function(a){var d=[];c.each(this,function(){var b=c(this).data("argenmap");b||(b=new p(this,a),c(this).data("argenmap",b),b.init())});return d.length?1===d.length?d[0]:d:this};c.fn.agregarCapaBaseWMS=function(a){return this.each(function(){if(c(this).data("argenmap")){var d=c(this).data("gmap");f.GmapAgregarCapaBase(d,new f.CapaBaseWMS({name:a.nombre,baseURL:a.url,layers:a.capas}))}})};c.fn.agregarCapaBaseTMS=function(a){return this.each(function(){if(c(this).data("argenmap")){var d=
c(this).data("gmap");f.GmapAgregarCapaBase(d,new f.CapaBaseTMS({name:a.nombre,baseURL:a.url,layers:a.capas}))}})};c.fn.agregarCapaWMS=function(a){return this.each(function(){if(c(this).data("argenmap")){var d=c(this).data("gmap");f.GmapAgregarCapa(d,new f.CapaWMS({name:a.nombre,baseURL:a.url,layers:a.capas}))}})};c.fn.agregarCapaTMS=function(a){return this.each(function(){if(c(this).data("argenmap")){var d=c(this).data("gmap");f.GmapAgregarCapaTMS(d,new f.CapaTMS({name:a.nombre,baseURL:a.url,layers:a.capas}))}})};
c.fn.agregarCapaKML=function(a){return this.each(function(){var d=c(this).data("argenmap");d&&d.agregarCapaKML(a)})};c.fn.centro=function(a,d){if(0===arguments.length){if(!this.data("argenmap"))return[];var b=this.data("gmap").getCenter();return b?[b.lat(),b.lng()]:[]}return this.each(function(){c(this).data("argenmap")&&c(this).data("gmap").setCenter(new google.maps.LatLng(a,d))})};c.fn.zoom=function(a){if(void 0===a){if(!this.data("argenmap"))return null;var d=this.data("gmap").getZoom();return d?
d:null}return this.each(function(){c(this).data("argenmap")&&c.isNumeric(a)&&c(this).data("gmap").setZoom(a)})};c.fn.capaBase=function(a){if(void 0===a){if(!this.data("argenmap"))return null;var d=this.data("gmap").mapTypeId;return d?d:null}return this.each(function(){c(this).data("argenmap")&&c(this).data("gmap").setMapTypeId(a)})};c.fn.agregarMarcador=function(a){var d=arguments;return this.each(function(){var b=c.extend({},a),e=c(this).data("argenmap");e&&(0===d.length&&(b.lat=c(this).data("gmap").getCenter().lat(),
b.lng=c(this).data("gmap").getCenter().lng()),b.hasOwnProperty("long")?b.lng=b["long"]:b.hasOwnProperty("lon")?b.lng=b.lon:b.hasOwnProperty("lat")&&"function"===typeof b.lat&&(b.lat=b.lat(),b.lng=b.lng()),e.agregarMarcador(b))})};c.fn.agregarMarcadores=function(a){return this.each(function(){var d=this;c(this).data("argenmap")&&c(a).each(function(a,e){c(d).agregarMarcador(e)})})};c.fn.limpiarMapa=function(a){return this.each(function(){c(this).data("argenmap")&&c(this).argenmap({accion:"limpiar"})})};
c.fn.quitarMarcador=function(a){return this.each(function(d,b){if("string"===typeof a){var e=c(this).data("argenmap");e&&e.quitarMarcador(a)}})};c.fn.modificarMarcador=function(a,d){return this.each(function(b,e){if("string"===typeof a&&void 0!==d&&"object"===typeof d){var f=c(this).data("argenmap");f&&f.modificarMarcador(a,d)}})}})(jQuery);
